import{Fragment as z,computed as R,defineComponent as V,h as $,inject as J,nextTick as k,onMounted as W,onUnmounted as G,provide as Q,ref as D,toRaw as v,watch as U,watchEffect as H}from"vue";import{Features as j,render as E,omit as N,compact as X}from"../../utils/render.js";import{useId as B}from"../../hooks/use-id.js";import{Keys as y}from"../../keyboard.js";import{calculateActiveIndex as Y,Focus as h}from"../../utils/calculate-active-index.js";import{dom as I}from"../../utils/dom.js";import{useOpenClosed as Z,State as K,useOpenClosedProvider as ee}from"../../internal/open-closed.js";import{match as M}from"../../utils/match.js";import{useResolveButtonType as te}from"../../hooks/use-resolve-button-type.js";import{useTreeWalker as oe}from"../../hooks/use-tree-walker.js";import{sortByDomNode as ne}from"../../utils/focus-management.js";import{useOutsideClick as ae}from"../../hooks/use-outside-click.js";import{Hidden as le,Features as ie}from"../../internal/hidden.js";import{objectToFormEntries as ue}from"../../utils/form.js";var re=(i=>(i[i.Open=0]="Open",i[i.Closed=1]="Closed",i))(re||{}),se=(i=>(i[i.Single=0]="Single",i[i.Multi=1]="Multi",i))(se||{}),pe=(i=>(i[i.Pointer=0]="Pointer",i[i.Other=1]="Other",i))(pe||{});let _=Symbol("ComboboxContext");function A(n){let O=J(_,null);if(O===null){let i=new Error(`<${n} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(i,A),i}return O}let Me=V({name:"Combobox",emits:{"update:modelValue":n=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},modelValue:{type:[Object,String,Number,Boolean]},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(n,{slots:O,attrs:i,emit:C}){let e=D(1),t=D(null),d=D(null),g=D(null),m=D(null),b=D({static:!1,hold:!1}),o=D([]),f=D(null),x=D(1),S=D(!1);function p(l=r=>r){let r=f.value!==null?o.value[f.value]:null,s=ne(l(o.value.slice()),c=>I(c.dataRef.domRef)),u=r?s.indexOf(r):null;return u===-1&&(u=null),{options:s,activeOptionIndex:u}}let T=R(()=>n.modelValue),w=R(()=>n.multiple?1:0),F=R(()=>n.nullable),a={comboboxState:e,value:T,mode:w,compare(l,r){return l===r},nullable:F,inputRef:d,labelRef:t,buttonRef:g,optionsRef:m,disabled:R(()=>n.disabled),options:o,change(l){C("update:modelValue",l)},activeOptionIndex:R(()=>{if(S.value&&f.value===null&&o.value.length>0){let l=o.value.findIndex(r=>!r.dataRef.disabled);if(l!==-1)return l}return f.value}),activationTrigger:x,inputPropsRef:D({displayValue:void 0}),optionsPropsRef:b,closeCombobox(){S.value=!1,!n.disabled&&e.value!==1&&(e.value=1,f.value=null)},openCombobox(){if(S.value=!0,n.disabled||e.value===0)return;let l=o.value.findIndex(r=>{let s=v(r.dataRef.value);return M(w.value,{[0]:()=>a.compare(v(a.value.value),v(s)),[1]:()=>v(a.value.value).some(c=>a.compare(v(c),v(s)))})});l!==-1&&(f.value=l),e.value=0},goToOption(l,r,s){if(S.value=!1,n.disabled||m.value&&!b.value.static&&e.value===1)return;let u=p();if(u.activeOptionIndex===null){let P=u.options.findIndex(L=>!L.dataRef.disabled);P!==-1&&(u.activeOptionIndex=P)}let c=Y(l===h.Specific?{focus:h.Specific,id:r}:{focus:l},{resolveItems:()=>u.options,resolveActiveIndex:()=>u.activeOptionIndex,resolveId:P=>P.id,resolveDisabled:P=>P.dataRef.disabled});f.value=c,x.value=s!=null?s:1,o.value=u.options},syncInputValue(){var s;let l=a.value.value;if(!I(a.inputRef))return;let r=a.inputPropsRef.value.displayValue;typeof r=="function"?a.inputRef.value.value=(s=r(l))!=null?s:"":typeof l=="string"?a.inputRef.value.value=l:a.inputRef.value.value=""},selectOption(l){let r=o.value.find(u=>u.id===l);if(!r)return;let{dataRef:s}=r;C("update:modelValue",M(w.value,{[0]:()=>s.value,[1]:()=>{let u=v(a.value.value).slice(),c=v(s.value),P=u.indexOf(c);return P===-1?u.push(c):u.splice(P,1),u}})),a.syncInputValue()},selectActiveOption(){if(a.activeOptionIndex.value===null)return;let{dataRef:l,id:r}=o.value[a.activeOptionIndex.value];C("update:modelValue",M(w.value,{[0]:()=>l.value,[1]:()=>{let s=v(a.value.value).slice(),u=v(l.value),c=s.indexOf(u);return c===-1?s.push(u):s.splice(c,1),s}})),a.syncInputValue(),a.goToOption(h.Specific,r)},registerOption(l,r){let s={id:l,dataRef:r},u=p(c=>[...c,s]);if(f.value===null){let c=r.value.value;M(w.value,{[0]:()=>a.compare(v(a.value.value),v(c)),[1]:()=>v(a.value.value).some(L=>a.compare(v(L),v(c)))})&&(u.activeOptionIndex=u.options.indexOf(s))}o.value=u.options,f.value=u.activeOptionIndex,x.value=1},unregisterOption(l){let r=p(s=>{let u=s.findIndex(c=>c.id===l);return u!==-1&&s.splice(u,1),s});o.value=r.options,f.value=r.activeOptionIndex,x.value=1}};ae([d,g,m],()=>a.closeCombobox(),R(()=>e.value===0)),U([a.value,a.inputRef],()=>a.syncInputValue(),{immediate:!0}),U(a.comboboxState,l=>{l===1&&a.syncInputValue()},{immediate:!0}),Q(_,a),ee(R(()=>M(e.value,{[0]:K.Open,[1]:K.Closed})));let q=R(()=>a.activeOptionIndex.value===null?null:o.value[a.activeOptionIndex.value].dataRef.value);return()=>{let{name:l,modelValue:r,disabled:s,...u}=n,c={open:e.value===0,disabled:s,activeIndex:a.activeOptionIndex.value,activeOption:q.value};return $(z,[...l!=null&&r!=null?ue({[l]:r}).map(([P,L])=>$(le,X({features:ie.Hidden,key:P,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:P,value:L}))):[],E({theirProps:{...i,...N(u,["nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:c,slots:O,attrs:i,name:"Combobox"})])}}}),ke=V({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"}},setup(n,{attrs:O,slots:i}){let C=A("ComboboxLabel"),e=`headlessui-combobox-label-${B()}`;function t(){var d;(d=I(C.inputRef))==null||d.focus({preventScroll:!0})}return()=>{let d={open:C.comboboxState.value===0,disabled:C.disabled.value},g={id:e,ref:C.labelRef,onClick:t};return E({ourProps:g,theirProps:n,slot:d,attrs:O,slots:i,name:"ComboboxLabel"})}}}),Ve=V({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"}},setup(n,{attrs:O,slots:i,expose:C}){let e=A("ComboboxButton"),t=`headlessui-combobox-button-${B()}`;C({el:e.buttonRef,$el:e.buttonRef});function d(b){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(b.preventDefault(),e.openCombobox()),k(()=>{var o;return(o=I(e.inputRef))==null?void 0:o.focus({preventScroll:!0})}))}function g(b){switch(b.key){case y.ArrowDown:b.preventDefault(),b.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),k(()=>{var o;return(o=e.inputRef.value)==null?void 0:o.focus({preventScroll:!0})});return;case y.ArrowUp:b.preventDefault(),b.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),k(()=>{e.value.value||e.goToOption(h.Last)})),k(()=>{var o;return(o=e.inputRef.value)==null?void 0:o.focus({preventScroll:!0})});return;case y.Escape:if(e.comboboxState.value!==0)return;b.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&b.stopPropagation(),e.closeCombobox(),k(()=>{var o;return(o=e.inputRef.value)==null?void 0:o.focus({preventScroll:!0})});return}}let m=te(R(()=>({as:n.as,type:O.type})),e.buttonRef);return()=>{var x,S;let b={open:e.comboboxState.value===0,disabled:e.disabled.value},o={ref:e.buttonRef,id:t,type:m.value,tabindex:"-1","aria-haspopup":!0,"aria-controls":(x=I(e.optionsRef))==null?void 0:x.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(S=I(e.labelRef))==null?void 0:S.id,t].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:g,onClick:d};return E({ourProps:o,theirProps:n,slot:b,attrs:O,slots:i,name:"ComboboxButton"})}}}),Ee=V({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function}},emits:{change:n=>!0},setup(n,{emit:O,attrs:i,slots:C,expose:e}){let t=A("ComboboxInput"),d=`headlessui-combobox-input-${B()}`;t.inputPropsRef=R(()=>n),e({el:t.inputRef,$el:t.inputRef});function g(o){switch(o.key){case y.Backspace:case y.Delete:if(t.mode.value!==0||!t.nullable.value)return;let f=o.currentTarget;requestAnimationFrame(()=>{if(f.value===""){t.change(null);let x=I(t.optionsRef);x&&(x.scrollTop=0),t.goToOption(h.Nothing)}});break;case y.Enter:if(t.comboboxState.value!==0)return;if(o.preventDefault(),o.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case y.ArrowDown:return o.preventDefault(),o.stopPropagation(),M(t.comboboxState.value,{[0]:()=>t.goToOption(h.Next),[1]:()=>t.openCombobox()});case y.ArrowUp:return o.preventDefault(),o.stopPropagation(),M(t.comboboxState.value,{[0]:()=>t.goToOption(h.Previous),[1]:()=>{t.openCombobox(),k(()=>{t.value.value||t.goToOption(h.Last)})}});case y.Home:case y.PageUp:return o.preventDefault(),o.stopPropagation(),t.goToOption(h.First);case y.End:case y.PageDown:return o.preventDefault(),o.stopPropagation(),t.goToOption(h.Last);case y.Escape:if(t.comboboxState.value!==0)return;o.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&o.stopPropagation(),t.closeCombobox();break;case y.Tab:if(t.comboboxState.value!==0)return;t.selectActiveOption(),t.closeCombobox();break}}function m(o){O("change",o)}function b(o){t.openCombobox(),O("change",o)}return()=>{var S,p,T,w,F,a;let o={open:t.comboboxState.value===0},f={"aria-controls":(S=t.optionsRef.value)==null?void 0:S.id,"aria-expanded":t.disabled.value?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(p=t.options.value[t.activeOptionIndex.value])==null?void 0:p.id,"aria-multiselectable":t.mode.value===1?!0:void 0,"aria-labelledby":(F=(T=I(t.labelRef))==null?void 0:T.id)!=null?F:(w=I(t.buttonRef))==null?void 0:w.id,id:d,onKeydown:g,onChange:m,onInput:b,role:"combobox",type:(a=i.type)!=null?a:"text",tabIndex:0,ref:t.inputRef},x=N(n,["displayValue"]);return E({ourProps:f,theirProps:x,slot:o,attrs:i,slots:C,features:j.RenderStrategy|j.Static,name:"ComboboxInput"})}}}),Ae=V({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(n,{attrs:O,slots:i,expose:C}){let e=A("ComboboxOptions"),t=`headlessui-combobox-options-${B()}`;C({el:e.optionsRef,$el:e.optionsRef}),H(()=>{e.optionsPropsRef.value.static=n.static}),H(()=>{e.optionsPropsRef.value.hold=n.hold});let d=Z(),g=R(()=>d!==null?d.value===K.Open:e.comboboxState.value===0);return oe({container:R(()=>I(e.optionsRef)),enabled:R(()=>e.comboboxState.value===0),accept(m){return m.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:m.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(m){m.setAttribute("role","none")}}),()=>{var f,x,S,p;let m={open:e.comboboxState.value===0},b={"aria-activedescendant":e.activeOptionIndex.value===null||(f=e.options.value[e.activeOptionIndex.value])==null?void 0:f.id,"aria-labelledby":(p=(x=I(e.labelRef))==null?void 0:x.id)!=null?p:(S=I(e.buttonRef))==null?void 0:S.id,id:t,ref:e.optionsRef,role:"listbox"},o=N(n,["hold"]);return E({ourProps:b,theirProps:o,slot:m,attrs:O,slots:i,features:j.RenderStrategy|j.Static,visible:g.value,name:"ComboboxOptions"})}}}),Fe=V({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(n,{slots:O,attrs:i,expose:C}){let e=A("ComboboxOption"),t=`headlessui-combobox-option-${B()}`,d=D(null);C({el:d,$el:d});let g=R(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),m=R(()=>M(e.mode.value,{[0]:()=>e.compare(v(e.value.value),v(n.value)),[1]:()=>v(e.value.value).some(p=>e.compare(v(p),v(n.value)))})),b=R(()=>({disabled:n.disabled,value:n.value,domRef:d}));W(()=>e.registerOption(t,b)),G(()=>e.unregisterOption(t)),H(()=>{e.comboboxState.value===0&&(!g.value||e.activationTrigger.value!==0&&k(()=>{var p,T;return(T=(p=I(d))==null?void 0:p.scrollIntoView)==null?void 0:T.call(p,{block:"nearest"})}))});function o(p){var T;if(n.disabled)return p.preventDefault();e.selectOption(t),e.mode.value===0&&(e.closeCombobox(),(T=I(e.inputRef))==null||T.focus({preventScroll:!0}))}function f(){if(n.disabled)return e.goToOption(h.Nothing);e.goToOption(h.Specific,t)}function x(){n.disabled||g.value||e.goToOption(h.Specific,t,0)}function S(){n.disabled||!g.value||e.optionsPropsRef.value.hold||e.goToOption(h.Nothing)}return()=>{let{disabled:p}=n,T={active:g.value,selected:m.value,disabled:p},w={id:t,ref:d,role:"option",tabIndex:p===!0?void 0:-1,"aria-disabled":p===!0?!0:void 0,"aria-selected":m.value===!0?m.value:void 0,disabled:void 0,onClick:o,onFocus:f,onPointermove:x,onMousemove:x,onPointerleave:S,onMouseleave:S};return E({ourProps:w,theirProps:n,slot:T,attrs:i,slots:O,name:"ComboboxOption"})}}});export{Me as Combobox,Ve as ComboboxButton,Ee as ComboboxInput,ke as ComboboxLabel,Fe as ComboboxOption,Ae as ComboboxOptions};
